<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://res.cloudinary.com/djttn4xvk/image/upload/v1744016662/iv8s8dkwdzxgnubsnhla.ico">
    <title>Poxel Competitive</title>
    <style>
        /* --- PASTE ALL YOUR ORIGINAL CSS HERE --- */
        :root {
            --dark: #121212;
            --dark-accent: #1e1e1e;
            --orange: #ff5722;
            --orange-light: #ff7e47;
            --orange-dark: #c41c00;
            --text: #f5f5f5;
            --text-secondary: #aaaaaa;
        }
        /* ... (rest of your original styles: *, body, header, logo, nav, etc.) ... */

        /* --- ADD NEW STYLES FOR AUTH/MODAL HERE --- */

        /* Login/Auth Container in Header */
        #auth-container {
            position: absolute;
            top: 1.5rem; /* Adjust as needed */
            right: 1.5rem; /* Adjust as needed */
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #login-register-btn {
            background-color: var(--orange);
            color: var(--text);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        #login-register-btn:hover {
            background-color: var(--orange-light);
        }
        #login-register-btn.loading { /* Style for initial loading text */
            background-color: #555;
            cursor: default;
        }

        #user-profile-link img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--orange);
            cursor: pointer;
            object-fit: cover; /* Ensures the image covers the area */
        }
        #user-profile-link img:hover {
            border-color: var(--orange-light);
        }

        /* Auth Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal.show {
            display: flex; /* Use flex to center */
            justify-content: center;
            align-items: center;
            opacity: 1;
        }


        .modal-content {
            background-color: var(--dark-accent);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 450px;
            position: relative; /* For the close button */
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }

        .close-btn {
            color: var(--text-secondary);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--orange);
            text-decoration: none;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--orange);
            font-size: 1.5rem;
        }

        /* Modal Form Styles */
        .auth-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .auth-form input[type="text"],
        .auth-form input[type="email"],
        .auth-form input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid #444;
            background-color: var(--dark);
            color: var(--text);
            border-radius: 4px;
            font-size: 1rem;
        }

        .auth-form input[type="text"]:focus,
        .auth-form input[type="email"]:focus,
        .auth-form input[type="password"]:focus {
            outline: none;
            border-color: var(--orange);
        }

        .auth-form button {
            width: 100%;
            padding: 0.8rem;
            background-color: var(--orange);
            border: none;
            color: var(--text);
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 0.5rem;
        }

        .auth-form button:hover {
            background-color: var(--orange-light);
        }

        /* Different IDs for login/register error messages */
        #auth-error-login,
        #auth-error-register {
            color: #f44336; /* Material Red */
            text-align: center;
            margin-top: 1rem;
            font-weight: 500;
            min-height: 1.2em; /* Reserve space */
        }

        .switch-form-link {
            display: block;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .switch-form-link button {
            background: none;
            border: none;
            color: var(--orange);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }
        .switch-form-link button:hover {
            color: var(--orange-light);
        }

        /* --- End of new styles --- */
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <!-- <img src="path/to/logo.png" alt="Poxel Logo" class="logo-icon"> -->
             <div class="logo-icon"></div>
            <h1>Poxel Competitive</h1>
        </div>
        <nav>
            <button class="nav-tab active" data-section="upcoming-matches">Upcoming Matches</button>
            <button class="nav-tab" data-section="leaderboard">Leaderboard</button>
            <button class="nav-tab" data-section="bracket">Tournament Bracket</button>
            <!-- <a href="admin.html" class="nav-tab" style="color: var(--orange-light);">Admin Panel</a> -->
        </nav>
        <!-- NEW: Auth container in header -->
        <div id="auth-container">
            <!-- Login button OR profile picture will be injected here by script -->
            <button id="login-register-btn" class="loading">Loading...</button> <!-- Initial state -->
        </div>
    </header>

    <main>
        <!-- Upcoming Matches Section -->
        <section id="upcoming-matches" class="content-section active">
           <!-- ... your existing upcoming matches content ... -->
             <h2 class="section-title">
                <span>üìÖ</span> Upcoming Matches
            </h2>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all">All Matches</button>
                <button class="filter-btn" data-filter="qualifiers">Qualifiers</button>
                <button class="filter-btn" data-filter="quarterfinals">Quarterfinals</button>
                <button class="filter-btn" data-filter="semifinals">Semifinals</button>
                <button class="filter-btn" data-filter="finals">Finals</button>
            </div>
            <div class="matches-grid" id="matches-container">
                <div class="loading-state">Loading matches...</div>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboard" class="content-section">
            <!-- ... your existing leaderboard content ... -->
            <h2 class="section-title">
                <span>üèÜ</span> Tournament Leaderboard
            </h2>
             <div class="filter-controls">
                <button class="filter-btn active" data-sort="rank">Rank</button>
                <button class="filter-btn" data-sort="wins">Wins</button>
                <button class="filter-btn" data-sort="points">Points</button>
                 <button class="filter-btn" data-sort="name">Name</button>
            </div>
             <div class="card">
                <table class="leaderboard-table" id="leaderboard-table">
                    <thead>
                        <tr>
                            <th class="rank">Rank</th>
                            <th>Player</th>
                            <th class="stats">Matches</th>
                            <th class="stats">Wins</th>
                            <th class="stats">Losses</th>
                            <th class="stats">Points</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                         <tr><td colspan="6" class="loading-state">Loading leaderboard...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Tournament Bracket Section -->
        <section id="bracket" class="content-section">
            <!-- ... your existing bracket content ... -->
             <h2 class="section-title">
                <span>‚öîÔ∏è</span> Tournament Bracket
            </h2>
             <div class="tournament-controls">
                <div class="filter-controls">
                    <button class="filter-btn active" data-tournament="pro">Pro Tourney</button>
                    <button class="filter-btn" data-tournament="novice">Novice Tourney</button>
                </div>
            </div>
             <div class="bracket-container">
                <div class="bracket" id="bracket-display-container">
                     <div class="loading-state">Loading bracket...</div>
                </div>
            </div>
        </section>
    </main>

    <!-- NEW: Login/Register Modal HTML (Add before closing body tag) -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-modal-btn">√ó</span>
            <h2 id="modal-title" class="modal-title">Login</h2>

            <!-- Login Form (Visible by default) -->
            <form id="login-form" class="auth-form">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" required>

                <label for="login-password">Password</label>
                <input type="password" id="login-password" required>

                <button type="submit">Login</button>
                <p id="auth-error-login"></p> <!-- Error messages for Login -->
            </form>

            <!-- Registration Form (Hidden by default) -->
            <form id="register-form" class="auth-form" style="display: none;">
                <label for="register-username">Username</label>
                <input type="text" id="register-username" required minlength="3">

                <label for="register-email">Email</label>
                <input type="email" id="register-email" required>

                <label for="register-password">Password</label>
                <input type="password" id="register-password" required minlength="6">

                <button type="submit">Register</button>
                 <p id="auth-error-register"></p> <!-- Separate Error for register -->
            </form>

            <div class="switch-form-link">
                <span id="switch-to-register-text">Don't have an account? <button type="button" id="switch-to-register">Register</button></span>
                <span id="switch-to-login-text" style="display: none;">Already have an account? <button type="button" id="switch-to-login">Login</button></span>
            </div>
        </div>
    </div>
    <!-- End of Modal HTML -->

    <!-- Firebase SDK -->
    <!-- Use the same SDK versions as in admin.html for consistency -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> <!-- ADDED Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- START OF COMBINED SCRIPT SECTION ---

        // 1. Firebase Configuration (Paste your actual config here)
        const firebaseConfig = {
            apiKey: "AIzaSyDWFPys8dbSgis98tbm5PVqMuHqnCpPIxI", // Replace with your REAL key
            authDomain: "poxelcomp.firebaseapp.com",
            projectId: "poxelcomp",
            storageBucket: "poxelcomp.firebasestorage.app", // Corrected: Usually *.appspot.com but check yours
            messagingSenderId: "620490990104",
            appId: "1:620490990104:web:709023eb464c7d886b996d",
        };

        // 2. Initialize Firebase
        if (!firebase.apps.length) { // Prevent double initialization
             firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth(); // Initialize Auth service

        // --- 3. Authentication Logic (Previously auth.js) ---

        // Moved Auth DOM Element selectors INSIDE DOMContentLoaded listener

        // Moved Modal Control Functions INSIDE DOMContentLoaded listener (or defined globally, careful with element access)

        // Moved Auth Form Submit Logic INSIDE DOMContentLoaded listener

        // Auth State Listener (This part can be defined outside DOMContentLoaded, it sets up a listener)
        auth.onAuthStateChanged(async (user) => {
            const authContainer = document.getElementById('auth-container'); // Get container fresh each time
             if (!authContainer) return; // Exit if container not found (shouldn't happen normally)

            if (user) {
                // User is signed in
                console.log("Auth state changed: User is logged in", user.uid);
                try {
                    // Fetch user data from Firestore
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    let displayName = user.email; // Fallback
                    let profilePicUrl = 'placeholder-avatar.png'; // Default avatar - UPDATE PATH AS NEEDED

                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        displayName = userData.username || user.email; // Use username if available
                        if (userData.avatarUrl) {
                            profilePicUrl = userData.avatarUrl;
                        }
                        console.log("User data fetched for header:", userData.username);
                    } else {
                         // This can happen if user registers but Firestore doc creation fails
                         // OR if Firestore rules block reading their own doc
                        console.warn("User document not found in Firestore for UID:", user.uid);
                         // Attempt to create the document if missing - often needed after social logins or if initial create failed
                         try {
                             await db.collection('users').doc(user.uid).set({
                                 uid: user.uid,
                                 email: user.email,
                                 username: user.email.split('@')[0], // Simple default username
                                 avatarUrl: null,
                                 bannerUrl: null,
                                 createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                 matches: 0, wins: 0, losses: 0, points: 0 // Initialize stats
                             }, { merge: true }); // Use merge to avoid overwriting if partially exists
                             console.log("Created missing user document for:", user.uid);
                         } catch (createError) {
                             console.error("Failed to create missing user document:", createError);
                         }
                    }

                    // Update header UI
                    authContainer.innerHTML = `
                        <a href="profile.html" id="user-profile-link" title="${displayName}">
                            <img src="${profilePicUrl}" alt="${displayName}">
                        </a>
                    `;
                } catch (error) {
                    console.error("Error fetching user data for header:", error);
                    authContainer.innerHTML = `
                        <a href="profile.html" id="user-profile-link" title="Profile">üë§</a> <!-- Simple icon fallback -->
                    `;
                }

            } else {
                // User is signed out
                console.log("Auth state changed: User is logged out");
                // Update header UI
                authContainer.innerHTML = `
                    <button id="login-register-btn">Login / Register</button>
                `;
                // !! Re-add listener to the NEW button INSIDE DOMContentLoaded or make sure it's added there !!
                 const loginRegBtn = document.getElementById('login-register-btn');
                 if (loginRegBtn && window.setupAuthModalListeners) { // Check if setup function exists
                     // We need to re-attach the click listener after innerHTML replaces the button
                     loginRegBtn.addEventListener('click', () => window.openAuthModal('login'));
                 } else if (!window.setupAuthModalListeners) {
                     console.warn("setupAuthModalListeners not defined yet when trying to re-attach listener after logout.");
                 }
            }
        });

        // --- 4. Existing Index Page Logic ---
        // Keep all your existing JS for tabs, Firestore data loading (matches, leaderboard, bracket), display logic etc. HERE

        // Global state (already present)
        let currentMatches = [];
        let currentLeaderboard = [];
        let currentBracket = {};

        // Helper Functions (already present)
        function createEmptyState(message, submessage) { /* ... */ }
        function formatDate(date) { /* ... */ }

        // Countdown Timer Logic (already present)
        const countdownIntervals = {};
        function stopAllCountdowns() { /* ... */ }
        function addCountdownTimer(matchElement, matchId, matchDateTimestamp) { /* ... */ }

        // --- 5. COMBINE Initialisation inside DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {

             // --- Define DOM Element Selectors for Auth Here ---
             const authContainer = document.getElementById('auth-container'); // Select again inside listener
             const modal = document.getElementById('auth-modal');
             const closeModalBtn = document.getElementById('close-modal-btn');
             const loginForm = document.getElementById('login-form');
             const registerForm = document.getElementById('register-form');
             const loginEmailInput = document.getElementById('login-email');
             const loginPasswordInput = document.getElementById('login-password');
             const registerUsernameInput = document.getElementById('register-username');
             const registerEmailInput = document.getElementById('register-email');
             const registerPasswordInput = document.getElementById('register-password');
             const authErrorLoginElement = document.getElementById('auth-error-login'); // Login error
             const authErrorRegisterElement = document.getElementById('auth-error-register'); // Register error

             const modalTitle = document.getElementById('modal-title');
             const switchToRegisterBtn = document.getElementById('switch-to-register');
             const switchToLoginBtn = document.getElementById('switch-to-login');
             const switchToRegisterText = document.getElementById('switch-to-register-text');
             const switchToLoginText = document.getElementById('switch-to-login-text');

             // --- Define Auth Helper Functions Here ---
             function openAuthModal(type = 'login') {
                 if (!modal || !loginForm || !registerForm) {
                     console.error("Auth modal elements not found!");
                     return;
                 }
                 authErrorLoginElement.textContent = ''; // Clear errors
                 authErrorRegisterElement.textContent = '';
                 loginForm.reset();
                 registerForm.reset();

                 if (type === 'register') {
                     modalTitle.textContent = 'Register';
                     loginForm.style.display = 'none';
                     registerForm.style.display = 'block';
                     switchToRegisterText.style.display = 'none';
                     switchToLoginText.style.display = 'block';
                 } else {
                     modalTitle.textContent = 'Login';
                     loginForm.style.display = 'block';
                     registerForm.style.display = 'none';
                     switchToRegisterText.style.display = 'block';
                     switchToLoginText.style.display = 'none';
                 }
                 modal.classList.add('show');
             }
             window.openAuthModal = openAuthModal; // Make accessible globally if needed (e.g., for re-attaching listener)

             function closeAuthModal() {
                 if (!modal) return;
                 modal.classList.remove('show');
                  // Reset to login view slightly after animation finishes
                  setTimeout(() => {
                      if (!modalTitle || !loginForm || !registerForm) return;
                       modalTitle.textContent = 'Login';
                       loginForm.style.display = 'block';
                       registerForm.style.display = 'none';
                       switchToRegisterText.style.display = 'block';
                       switchToLoginText.style.display = 'none';
                       if(authErrorLoginElement) authErrorLoginElement.textContent = '';
                       if(authErrorRegisterElement) authErrorRegisterElement.textContent = '';
                       loginForm.reset();
                       registerForm.reset();
                  }, 300); // Match CSS transition duration
             }

             // --- Setup Auth Modal Listeners Here ---
             function setupAuthModalListeners() {
                 const initialLoginRegBtn = document.getElementById('login-register-btn');
                 if(initialLoginRegBtn) initialLoginRegBtn.addEventListener('click', () => openAuthModal('login'));
                 if(closeModalBtn) closeModalBtn.addEventListener('click', closeAuthModal);
                 if(switchToRegisterBtn) switchToRegisterBtn.addEventListener('click', () => openAuthModal('register'));
                 if(switchToLoginBtn) switchToLoginBtn.addEventListener('click', () => openAuthModal('login'));

                 // Close if clicked outside modal content
                 if(modal) {
                     modal.addEventListener('click', (event) => {
                         if (event.target == modal) {
                            closeAuthModal();
                         }
                     });
                 }

                 // Login Form Submission
                 if(loginForm) {
                     loginForm.addEventListener('submit', async (e) => {
                         e.preventDefault();
                         authErrorLoginElement.textContent = '';
                         const email = loginEmailInput.value;
                         const password = loginPasswordInput.value;
                         try {
                             await auth.signInWithEmailAndPassword(email, password);
                             closeAuthModal();
                             console.log("User logged in successfully");
                         } catch (error) {
                             console.error("Login Error:", error.message);
                             authErrorLoginElement.textContent = `Login failed: ${error.message}`;
                         }
                     });
                 }

                 // Registration Form Submission
                 if(registerForm) {
                      registerForm.addEventListener('submit', async (e) => {
                         e.preventDefault();
                         authErrorRegisterElement.textContent = '';
                         const username = registerUsernameInput.value.trim();
                         const email = registerEmailInput.value;
                         const password = registerPasswordInput.value;

                         if (username.length < 3) {
                             authErrorRegisterElement.textContent = 'Username must be at least 3 characters.';
                             return;
                         }
                          if (password.length < 6) {
                              authErrorRegisterElement.textContent = 'Password must be at least 6 characters.';
                              return;
                          }

                         try {
                             // 1. Create user in Firebase Auth
                             const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                             const user = userCredential.user;
                             console.log("User registered in Auth:", user.uid);

                             // 2. Create user document in Firestore
                             const userRef = db.collection('users').doc(user.uid);
                             await userRef.set({
                                 uid: user.uid,
                                 username: username,
                                 email: email,
                                 avatarUrl: null, // Default
                                 bannerUrl: null, // Default
                                 createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                 // Initialize stats
                                 matches: 0,
                                 wins: 0,
                                 losses: 0,
                                 points: 0
                             });
                             console.log("User document created in Firestore for:", username);

                             // Redirect to profile page after successful registration
                             window.location.href = 'profile.html';
                             // closeAuthModal(); // Don't need to close if redirecting

                         } catch (error) {
                             console.error("Registration Error:", error);
                             authErrorRegisterElement.textContent = `Registration failed: ${error.message}`;
                         }
                     });
                 }
             }
            window.setupAuthModalListeners = setupAuthModalListeners; // Make globally accessible
            setupAuthModalListeners(); // Call it now that DOM is ready

            // --- Call Existing Index Page Initialisation Function (`init`) ---
            // Ensure your original 'init' function selects its elements *after* DOM is ready as well.
            // It's safe to call it here.

            // DOM Elements for Index Page Content (Ensure these are correct IDs)
             const tabButtons = document.querySelectorAll('.nav-tab');
             const contentSections = document.querySelectorAll('.content-section');
             const matchesContainer = document.getElementById('matches-container');
             const leaderboardBody = document.getElementById('leaderboard-body');
             const bracketDisplayContainer = document.getElementById('bracket-display-container'); // Updated ID

             // Function to Setup Firestore Listeners (for index content)
             let matchesListener = null;
             let leaderboardListener = null;
             let proBracketListener = null;
             let noviceBracketListener = null;

             function setupFirestoreListeners() {
                // --- Matches Listener ---
                if (matchesListener) matchesListener();
                matchesListener = db.collection('matches').orderBy('date', 'asc')
                    .onSnapshot(snapshot => {
                        currentMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const activeFilter = document.querySelector('#upcoming-matches .filter-btn.active')?.dataset.filter || 'all';
                        filterAndDisplayMatches(activeFilter);
                        console.log("Matches updated from Firestore");
                    }, error => {
                        console.error("Error fetching matches:", error);
                        matchesContainer.innerHTML = createEmptyState('Error loading matches', 'Could not fetch data.');
                    });

                // --- Leaderboard Listener ---
                if (leaderboardListener) leaderboardListener();
                leaderboardListener = db.collection('leaderboard').orderBy('points', 'desc').orderBy('wins', 'desc')
                    .onSnapshot(snapshot => {
                        currentLeaderboard = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const activeSort = document.querySelector('#leaderboard .filter-btn.active')?.dataset.sort || 'rank';
                        sortAndDisplayLeaderboard(activeSort);
                        console.log("Leaderboard updated from Firestore");
                    }, error => {
                        console.error("Error fetching leaderboard:", error);
                        leaderboardBody.innerHTML = `<tr><td colspan="6">${createEmptyState('Error loading leaderboard', 'Could not fetch data.')}</td></tr>`;
                    });

                // --- Bracket Listeners ---
                 if (proBracketListener) proBracketListener();
                 proBracketListener = db.collection('brackets').doc('pro')
                    .onSnapshot(doc => {
                        currentBracket.pro = doc.exists ? { id: doc.id, ...doc.data() } : null;
                        if(document.querySelector('#bracket .filter-btn.active[data-tournament="pro"]')) displayBracket('pro');
                        console.log("Pro Bracket updated");
                    }, error => { console.error("Error fetching pro bracket:", error); /* Show error */ });

                 if (noviceBracketListener) noviceBracketListener();
                 noviceBracketListener = db.collection('brackets').doc('novice')
                     .onSnapshot(doc => {
                        currentBracket.novice = doc.exists ? { id: doc.id, ...doc.data() } : null;
                         if(document.querySelector('#bracket .filter-btn.active[data-tournament="novice"]')) displayBracket('novice');
                         console.log("Novice Bracket updated");
                     }, error => { console.error("Error fetching novice bracket:", error); /* Show error */ });
             }


            // Tab Switching and Filtering/Sorting Logic (already present)
            function switchTab(sectionId) { /* ... same as before ... */
                tabButtons.forEach(button => button.classList.toggle('active', button.dataset.section === sectionId));
                contentSections.forEach(section => section.classList.toggle('active', section.id === sectionId));
             }
             function filterAndDisplayMatches(filter = 'all') { /* ... same as before ... */
                  matchesContainer.innerHTML = '';
                  stopAllCountdowns();
                  // Filtering logic...
                  // If no matches, show empty state...
                  // ForEach loop to create match cards... (use formatDate, addCountdownTimer)
                   const filteredMatches = currentMatches.filter(match => {
                       if (!match.date || !match.date.toDate) return false;
                       const matchDate = match.date.toDate();
                       const now = new Date();
                       if (matchDate < new Date(now.setHours(0,0,0,0))) return false;
                       if (filter === 'all') return true;
                       return match.type?.toLowerCase() === filter.toLowerCase();
                   });

                   if (filteredMatches.length === 0) {
                       matchesContainer.innerHTML = createEmptyState(`No upcoming ${filter} matches`, 'Try viewing all matches.');
                       return;
                   }
                   filteredMatches.forEach(match => {
                      // ... create match element ... (copied from original script)
                       const matchElement = document.createElement('div');
                       matchElement.className = 'card match-card fade-in'; // Add fade-in if desired
                       matchElement.innerHTML = `
                            <div class="match-header">
                                <span class="match-date">${formatDate(match.date)}</span>
                                <span class="match-type">${match.type || 'TBD'}</span>
                            </div>
                            <div class="match-countdown" data-match-id="${match.id}"></div>
                            <div class="match-teams">
                                <div class="team">
                                    <div class="team-logo">${match.team1?.logo || 'T1'}</div>
                                    <span class="team-name">${match.team1?.name || 'Team 1'}</span>
                                </div>
                                <div class="versus">VS</div>
                                <div class="team">
                                    <div class="team-logo">${match.team2?.logo || 'T2'}</div>
                                    <span class="team-name">${match.team2?.name || 'Team 2'}</span>
                                </div>
                            </div>
                            <div class="match-footer">
                                <span>${match.venue || 'Venue TBD'}</span>
                                ${match.streamLink ? `<a href="${match.streamLink}" target="_blank">Watch</a>` : '<span>No Stream</span>'}
                            </div>
                       `;
                       matchesContainer.appendChild(matchElement);
                       addCountdownTimer(matchElement, match.id, match.date);
                   });

             }
            function sortAndDisplayLeaderboard(sortBy = 'rank') { /* ... same as before ... */
                  leaderboardBody.innerHTML = '';
                  let sortedData = [...currentLeaderboard];
                   // Sorting logic...
                  if (sortBy === 'wins') sortedData.sort((a, b) => (b.wins || 0) - (a.wins || 0));
                  else if (sortBy === 'points') sortedData.sort((a, b) => (b.points || 0) - (a.points || 0));
                  else if (sortBy === 'name') sortedData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                   // else: default Firestore order (points desc, wins desc) is used for 'rank'

                   if (sortedData.length === 0) {
                       leaderboardBody.innerHTML = `<tr><td colspan="6">${createEmptyState('Leaderboard is empty', '')}</td></tr>`; return;
                   }
                   sortedData.forEach((player, index) => {
                      // ... create leaderboard row ... (copied from original script)
                      const row = document.createElement('tr');
                      row.className = 'fade-in'; // Add fade-in if desired
                       const rank = index + 1;
                       row.innerHTML = `
                          <td class="rank ${rank <= 3 ? 'top-rank' : ''}">${rank}</td>
                           <td>
                               <div class="player">
                                   <div class="player-avatar">${player.avatar || '?'}</div>
                                   <div class="player-name">${player.name || 'Unknown'}</div>
                               </div>
                           </td>
                           <td class="stats">${player.matches || 0}</td>
                           <td class="stats">${player.wins || 0}</td>
                           <td class="stats">${player.losses || 0}</td>
                           <td class="stats">${player.points || 0}</td>
                       `;
                       leaderboardBody.appendChild(row);
                   });

             }
            function displayBracket(tournament = 'pro') { /* ... same as before ... */
                 bracketDisplayContainer.innerHTML = '';
                 const data = currentBracket[tournament];
                 if (!data || !data.rounds || data.rounds.length === 0) {
                     bracketDisplayContainer.innerHTML = createEmptyState(`No ${tournament} bracket`, 'Not set up yet.');
                     return;
                 }
                 // ForEach loop to create rounds and matches...
                  data.rounds.forEach((round, roundIndex) => {
                     // ... create round element ... (copied from original script)
                     const roundElement = document.createElement('div');
                      roundElement.className = 'round fade-in'; // Add fade-in if desired
                       roundElement.innerHTML = `<h3 class="round-title">${round.name || `Round ${roundIndex + 1}`}</h3>`;
                      round.matches.forEach(match => {
                           // ... create match element ... (copied from original script)
                          const matchElement = document.createElement('div');
                           let t1Winner = (match.winner && ((match.team1.id && match.winner === match.team1.id) || (!match.team1.id && match.winner === match.team1.name)));
                           let t2Winner = (match.winner && ((match.team2.id && match.winner === match.team2.id) || (!match.team2.id && match.winner === match.team2.name)));
                           matchElement.className = `match-bracket ${match.completed ? 'completed' : 'upcoming'}`;
                           matchElement.innerHTML = `
                                <div class="bracket-team ${t1Winner ? 'bracket-winner' : ''}">
                                    <span class="bracket-team-name">${match.team1?.name || 'TBD'}</span>
                                    <span class="bracket-score">${match.completed && match.team1?.score != null ? match.team1.score : '-'}</span>
                                </div>
                                <div class="bracket-team ${t2Winner ? 'bracket-winner' : ''}">
                                    <span class="bracket-team-name">${match.team2?.name || 'TBD'}</span>
                                    <span class="bracket-score">${match.completed && match.team2?.score != null ? match.team2.score : '-'}</span>
                                </div>
                           `;
                           roundElement.appendChild(matchElement);
                      });
                      bracketDisplayContainer.appendChild(roundElement);
                 });

             }

            // Initialisation Function (`init` from original script)
             function initIndexPage() {
                 console.log("Initializing index page content listeners...");
                 // Set up navigation tabs
                 tabButtons.forEach(button => {
                     button.addEventListener('click', () => switchTab(button.dataset.section));
                 });

                 // Set up filter/sort buttons (must check elements exist)
                 document.querySelectorAll('.filter-btn').forEach(btn => {
                      btn.addEventListener('click', (e) => {
                         const parentControls = e.target.closest('.filter-controls, .tournament-controls');
                         if (!parentControls) return;
                         parentControls.querySelectorAll('.filter-btn').forEach(sibling => sibling.classList.remove('active'));
                         e.target.classList.add('active');

                         const section = e.target.closest('.content-section, .tournament-controls');
                          if (section?.id === 'upcoming-matches' || section?.querySelector('#upcoming-matches')) {
                              filterAndDisplayMatches(e.target.dataset.filter);
                         } else if (section?.id === 'leaderboard' || section?.querySelector('#leaderboard')) {
                              sortAndDisplayLeaderboard(e.target.dataset.sort);
                         } else if (section?.classList.contains('tournament-controls') || section?.querySelector('#bracket')) {
                              const tourneyType = parentControls.querySelector('.filter-btn.active[data-tournament]')?.dataset.tournament || 'pro';
                              displayBracket(tourneyType);
                         }
                      });
                 });

                 // Load initial data using Firestore listeners
                 setupFirestoreListeners(); // Defined above inside DOMContentLoaded

                 // Make sure the initial view is correct
                 // (onAuthStateChanged will handle the auth button, init handles the main content)
                 // Find the active tab and ensure its content is displayed correctly on load
                 const activeTabButton = document.querySelector('.nav-tab.active');
                  if (activeTabButton) {
                      switchTab(activeTabButton.dataset.section); // Ensure correct section visible
                  } else {
                       switchTab('upcoming-matches'); // Default to upcoming matches if none active
                  }
             }

            initIndexPage(); // Execute the index page initialisation

        }); // --- End of DOMContentLoaded listener ---

        // --- END OF COMBINED SCRIPT SECTION ---
    </script>
</body>
</html>
